<!DOCTYPE html>
<html>
  <head>
    <style>
      #app {
        padding: 50px 0px;
        font-size: 150px;
        text-align: center;
      }
      button.reload {
        font-size: 150px;
      }
      .kyocho {
        color: red;
      }
      [v-cloak] {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="app" v-cloak>
      <h1 v-html="currentContent"></h1>
      <button class="reload" v-if="done" @click="reloadPage">もう一回</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      //-------------
      new Vue({
        el: '#app',
        //
        data: {
          currentContent: '',
          cards: [],
        },
        //
        computed: {
          done() {
            return (this.cards.length < 1);
          },
        },
        //
        methods: {
          //
          getRandomInt (max)  {
            return Math.floor(Math.random() * Math.floor(max));
          },
          //
          nextTarget (num) {
            if (num < 1) {
              return null;
            }
            return this.getRandomInt(num);
          },
          //
          paramOf (s, key) {
            if (!s) return null;
            if (s === '') return null;
            var regex = new RegExp(key + "=([^&]+)");
            
            var m = s.match(regex)
            if (m) {
              return m[1];
            }
            return null;
          },
          //
          nextCard(event) {
            console.log('asdf_asdf');
            
            const index = this.nextTarget(this.cards.length);
            
            if (index == null) {
              this.currentContent = '終わり';
              return;
            }
            var item = this.cards[index];
            
            if (typeof(item) == "string") {
              item = {
                text: item,
                html: null,
                read: item,
              }
            }
            if (!(item.read)) {
              item.read = item.text;
            }
            
            if (item.html) {
              this.currentContent = item.html
            } else {
              this.currentContent = item.text
            }
            
            try {
              speechSynthesis.speak(new SpeechSynthesisUtterance(item.read))
            } catch(e) {
              console.log(e);
            }
            this.cards.splice(index, 1);
          },
          //
          reloadPage() {
            location.reload();
          },
        },
        //
        created () {
          const s = location.search;
          
          const sec = parseInt((this.paramOf(s, 'sec') || '-1'), 10);

          const dataType = (this.paramOf(s, 'data') || 'cities');
          
          const jsonUrl = "https://raw.githubusercontent.com/masa-kunikata/carta_reader/master/data/" + dataType + ".json"
          axios.get(jsonUrl)
            .then((res) => {
              this.cards = res.data
              // console.log(this.cards);
            })
            .then(() => {
              window.addEventListener('click', this.nextCard);
              window.addEventListener('keydown', this.nextCard);
            })
        },
        //
        beforeDestoy () {
          window.removeEventListener('click', this.nextCard);
          window.removeEventListener('keydown', this.nextCard);
        },
      });
    </script>
  </body>
</html>